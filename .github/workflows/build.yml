name: Build Binaries

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
            artifact_name: pdf-compare
            artifact_path: dist/pdf-compare
            build_script: scripts/build_linux.py
          - os: macos-latest
            name: macOS
            artifact_name: PDF-Compare-macOS
            artifact_path: dist/PDF Compare.app
            build_script: scripts/build_macos.py
          - os: windows-latest
            name: Windows
            artifact_name: PDF-Compare.exe
            artifact_path: dist/PDF Compare.exe
            build_script: scripts/build_windows.py

    runs-on: ${{ matrix.os }}
    name: Build ${{ matrix.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-groups

      # Linux: Install Poppler
      - name: Install Poppler (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      # macOS: Install Poppler via Homebrew
      - name: Install Poppler (macOS)
        if: matrix.os == 'macos-latest'
        run: brew install poppler

      # Windows: Download Poppler
      - name: Install Poppler (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $poppler_version = "24.08.0"
          $poppler_url = "https://github.com/oschwartz10612/poppler-windows/releases/download/v$poppler_version-0/Release-$poppler_version-0.zip"
          Invoke-WebRequest -Uri $poppler_url -OutFile poppler.zip
          Expand-Archive -Path poppler.zip -DestinationPath vendor
          Rename-Item -Path "vendor/poppler-$poppler_version" -NewName "poppler"

      - name: Build executable
        run: uv run python ${{ matrix.build_script }}

      # Upload artifact (different handling for .app bundle on macOS)
      - name: Upload artifact (Linux/Windows)
        if: matrix.os != 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

      - name: Upload artifact (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Linux binary
          cp artifacts/pdf-compare/pdf-compare release/pdf-compare-linux
          chmod +x release/pdf-compare-linux

          # Windows executable
          cp "artifacts/PDF-Compare.exe/PDF Compare.exe" release/PDF-Compare-windows.exe

          # macOS app bundle (zip it)
          cd artifacts/PDF-Compare-macOS
          zip -r ../../release/PDF-Compare-macOS.zip "PDF Compare.app"
          cd ../..

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/pdf-compare-linux
            release/PDF-Compare-windows.exe
            release/PDF-Compare-macOS.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
